<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tiefenkarten PRO</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
body { margin:0; font-family:Arial; }
#map { height:90vh; }
.controls { padding:10px; background:#f4f4f4; display:flex; gap:10px; flex-wrap:wrap; }
button { padding:6px 12px; cursor:pointer; }
</style>
</head>
<body>

<div class="controls">
<button id="btnSwim">Swim + Ringe erstellen</button>
<button id="btnClear">Alles l√∂schen</button>
</div>

<div id="map"></div>

<script>
const map = L.map("map").setView([51,10],6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
maxZoom:19
}).addTo(map);

const drawnItems = new L.FeatureGroup().addTo(map);

const drawControl = new L.Control.Draw({
draw:{
polygon:true,
polyline:false,
rectangle:false,
circle:false,
marker:false,
circlemarker:false
},
edit:{featureGroup:drawnItems}
});
map.addControl(drawControl);

let lakePolygon = null;
let swim = null;
let castPoints = [];
let depthPoints = [];
let heatLayer = null;

map.on(L.Draw.Event.CREATED,function(e){
drawnItems.clearLayers();
drawnItems.addLayer(e.layer);
lakePolygon = e.layer;
});

function pointInPolygon(latlng){
if(!lakePolygon) return false;
return leafletPip.pointInLayer(latlng,lakePolygon).length > 0;
}

/* LeafletPip minimal */
const leafletPip = {
pointInLayer:function(p,layer){
let results=[];
layer.eachLayer?layer.eachLayer(l=>{
if(leafletPip.pointInLayer(p,l).length)results.push(l);
}):(
leafletPip._pointInPolygon(p,layer.getLatLngs()[0])&&results.push(layer)
);
return results;
},
_pointInPolygon:function(point,vs){
let x=point.lat,y=point.lng;
let inside=false;
for(let i=0,j=vs.length-1;i<vs.length;j=i++){
let xi=vs[i].lat,yi=vs[i].lng;
let xj=vs[j].lat,yj=vs[j].lng;
let intersect=((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi);
if(intersect)inside=!inside;
}
return inside;
}
};

const R=6371000;
function dest(lat,lng,dist,bearing){
let br=bearing*Math.PI/180;
let lat1=lat*Math.PI/180;
let lon1=lng*Math.PI/180;
let dr=dist/R;
let lat2=Math.asin(Math.sin(lat1)*Math.cos(dr)+Math.cos(lat1)*Math.sin(dr)*Math.cos(br));
let lon2=lon1+Math.atan2(Math.sin(br)*Math.sin(dr)*Math.cos(lat1),Math.cos(dr)-Math.sin(lat1)*Math.sin(lat2));
return [lat2*180/Math.PI,lon2*180/Math.PI];
}

document.getElementById("btnSwim").addEventListener("click",()=>{
if(!lakePolygon){alert("Erst Polygon zeichnen!");return;}

alert("Swim setzen");
map.once("click",e=>{
swim=e.latlng;
L.marker(swim).addTo(map).bindPopup("Swim");

let maxRadius=parseFloat(prompt("Max Radius (m):","120"));
let lines=parseInt(prompt("Anzahl Linien:","6"));
let spacing=parseFloat(prompt("Punktabstand (m):","10"));

let step=maxRadius/lines;

for(let i=1;i<=lines;i++){
let r=step*i;
L.circle(swim,{radius:r,color:"#333",weight:1,fill:false}).addTo(map);

let circumference=2*Math.PI*r;
let count=Math.max(4,Math.round(circumference/spacing));
let angleStep=360/count;

for(let k=0;k<count;k++){
let bearing=k*angleStep;
let p=dest(swim.lat,swim.lng,r,bearing);
let latlng=L.latLng(p[0],p[1]);

if(pointInPolygon(latlng)){
let marker=L.circleMarker(latlng,{radius:5,color:"#666"}).addTo(map);
castPoints.push({lat:p[0],lng:p[1]});

marker.on("click",()=>{
let d=parseFloat(prompt("Tiefe (m):"));
if(!isNaN(d)){
depthPoints.push({lat:p[0],lng:p[1],depth:d});
updateHeat();
}
});
}
}
}
});
});

function updateHeat(){
if(heatLayer) map.removeLayer(heatLayer);

let heatData=depthPoints.map(p=>{
let normalized=Math.min(15,Math.max(1,p.depth))/15;
return [p.lat,p.lng,normalized];
});

heatLayer=L.heatLayer(heatData,{
radius:30,
blur:20,
maxZoom:17,
gradient:{
0.0:"blue",
0.3:"cyan",
0.5:"lime",
0.7:"yellow",
0.85:"orange",
1.0:"red"
}
}).addTo(map);
}

document.getElementById("btnClear").addEventListener("click",()=>{
location.reload();
});
</script>

</body>
</html>
